// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                Int               @id @default(autoincrement())
  firstName         String?            @map("first_name")
  lastName          String?           @map("last_name")
  phoneNo           String?               @map("phone_no")
  address           String?            @map("address")
  dateOfBirth       DateTime?          @map("DOB")
  gender            String?            @map("gender")
  state             String?            @map("state")
  country           String?            @map("country")
  profileImage      String?
  currenrStudyLevel currenrStudylevel? @map("current_studylevel")
  email             String            @unique
  username          String            @unique
  password          String
  isActive          Boolean           @default(true)
  isDeleted         Boolean           @default(false) @map("isdeleted")
  deletedAt         DateTime?         @map("deleted_at")
  createdAt         DateTime          @default(now())
  updatedAt         DateTime?         @map("updated_at")
  
  userRoleMappings  UserRoleMapping[] 
  ContestAttempt    ContestAttempt[]
  ChallengeAttempt  ChallengeAttempt[]
  consultationRequests ConsultationRequest[]
  meetings               Meeting[]
  enrolledCourses        CourseUserMapper[]

  @@map("users")
}

enum currenrStudylevel {
  PRIMARY_SCHOOL
  MIDDLE_SCHOOL
  HIGH_SCHOOL
  SENIOR_SECONDARY
  UNDERGRADUATE
  POSTGRADUATE
  DOCTORATE
}

model roles {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  description      String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime?         @map("updated_at")
  userRoleMappings UserRoleMapping[]

  @@map("roles")
 
}

model UserRoleMapping {
  id         Int      @id @default(autoincrement())
  userId     Int
  roleId     Int
  assignedAt DateTime @default(now())
  assignedBy Int?
  user       User     @relation(fields: [userId], references: [id])  // Relation to User based on userId
  role       roles    @relation(fields: [roleId], references: [id])

  @@index([userId], name: "idx_user_id")
  @@index([roleId], name: "idx_role_id")
  @@unique([userId, roleId])
  @@map("user_role_mapping")
}


model Courses {
  id           Int      @id @default(autoincrement())
  title        String
  description  String?
  price        Float
  thumbnailUrl String?
  instructor   String?
  duration     String?      

  level        CourseLevel
  category     String?
  language     String?

  isPublished  Boolean   @default(false)
  createdBy    Int?
  createdAt    DateTime?  @default(now())
  lessons      Lessons[]
  enrolledUsers CourseUserMapper[]

  @@map("courses")
}

enum CourseLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

model Lessons {
  id            Int      @id @default(autoincrement())
  courseId      Int
  title         String
  description   String?
  videoType     String    // e.g., "youtube", "vimeo", "self-hosted"
  videoId      String
  duration      Int?      // seconds
  order         Int      // lesson sequence
  isFreePreview Boolean

  course        Courses  @relation(fields: [courseId], references: [id])

  @@map("lessons")
  @@index([courseId])
}

model CourseUserMapper {
  id            Int      @id @default(autoincrement())
  userId        Int
  courseId      Int
  enrolledAt    DateTime @default(now())
  completedAt   DateTime?
  progress      Int      @default(0) // Percentage 0-100
  isCompleted   Boolean  @default(false)
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  course        Courses  @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@map("course_user_mapper")
  @@index([userId])
  @@index([courseId])
}

model Contest {
  id                Int       @id @default(autoincrement())
  title             String
  description       String?
  category          String    
  startTime         DateTime
  endTime           DateTime
  isPublished       Boolean  @default(false)
  durationMinutes   Int?
  totalMarks        Int?
  isActive          Boolean   @default(true)
  createdByAdminId  Int?
  createdAt        DateTime  @default(now())
  ContestQuestion  ContestQuestion[]
  ContestAttempt   ContestAttempt[]

  @@map("contest")
}

model ContestQuestion {
  id            Int     @id @default(autoincrement())
  contestId     Int
  questionText  String
  optionA       String
  optionB       String
  optionC       String?
  optionD       String?
  correctOption String   
  marks         Int
  contestanswer ContestAnswer[]

  contest       Contest @relation(fields: [contestId], references: [id])

  @@map("contest_questions")
  @@index([contestId])
}

model ContestAttempt {
  id          Int      @id @default(autoincrement())
  contestId   Int
  userId      Int
  startedAt   DateTime
  submittedAt DateTime?
  score       Int?
  timeTaken   Int?    // in seconds
  ContestAnswer ContestAnswer[]

  contest     Contest  @relation(fields: [contestId], references: [id])
  user        User     @relation(fields: [userId], references: [id])

  @@map("contest_attempts")
  @@index([contestId])
  @@index([userId])
}

model ContestAnswer {
  id             Int               @id @default(autoincrement())
  attemptId      Int
  questionId     Int
  selectedOption String
  isCorrect      Boolean

  attempt        ContestAttempt    @relation(fields: [attemptId], references: [id])
  question       ContestQuestion   @relation(fields: [questionId], references: [id])

  @@map("contest_answers")
  @@index([attemptId])
  @@index([questionId])
}

model Challenge {
  id         Int      @id @default(autoincrement())
  title      String
  type       ChallengeType
  category   String
  difficulty String
  points     Int
  startDate  DateTime
  endDate    DateTime
  isActive   Boolean

  ChallengeAttempt ChallengeAttempt[]

  @@map("challenges")
}

model ChallengeAttempt {
  id           Int       @id @default(autoincrement())
  challengeId  Int
  userId       Int
  completedAt  DateTime?
  earnedPoints Int

  challenge    Challenge @relation(fields: [challengeId], references: [id])
  user         User      @relation(fields: [userId], references: [id])

  @@map("challenge_attempts")
  @@index([challengeId])
  @@index([userId])
}


model Counselor {
  id               String   @id @default(uuid())

  // Basic Info
  name             String
  email            String   @unique
  password         String   // hashed
  bio              String?
  profileImage     String?

  // Professional Info
  specialization   String?
  experience       Int?      // years
  employmentType   EmploymentType

  // Runtime State
  isActive         Boolean  @default(false) // REAL-TIME availability

  // Stats (denormalized for performance)
  rating           Float    @default(0)
  totalMeetings    Int      @default(0)
  totalRevenue     Float    @default(0)

  // Relations
  consultationRequests ConsultationRequest[]
  meetings               Meeting[]

  // Audit
  createdByAdminId String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}


model ConsultationRequest {
  id            Int   @id @default(autoincrement())

  userId        Int // Changed from String -> Int
  counselorId   String

  requestType   ConsultationType
  scheduledAt   DateTime?  // only for SCHEDULED

  status        ConsultationStatus @default(PENDING)

  message       String?
  respondedAt   DateTime?

  // Relations
  user          User      @relation(fields: [userId], references: [id])
  counselor     Counselor @relation(fields: [counselorId], references: [id])
  meeting       Meeting?

  createdAt     DateTime @default(now())
}


model Meeting {
  id                     String   @id @default(uuid())

  consultationRequestId  Int   @unique
  counselorId            String
  userId                 Int // Changed from String -> Int

  meetingProvider        MeetingProvider
  meetingRoomId          String

  startTime              DateTime?
  endTime                DateTime?
  duration               Int? // seconds

  status                 MeetingStatus @default(ONGOING)

  // Relations
  consultationRequest ConsultationRequest @relation(fields: [consultationRequestId], references: [id])

  counselor Counselor @relation(fields: [counselorId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  createdAt DateTime @default(now())
}



model Resource {
  id          Int      @id @default(autoincrement())
  title       String
  description String?
  category    ResourceCategory
  type        String   // e.g., "PDF", "MP4", "PNG", "DOCX"
  url         String   // Cloudinary URL
  size        String?  // e.g., "2.5 MB"
  uploadedBy  String?
  downloads   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("resources")
}

enum ResourceCategory {
  DOCUMENT
  VIDEO
  IMAGE
  OTHER
}

enum ChallengeType {
  DAILY
  WEEKLY
  MONTHLY
}

enum EmploymentType {
  PART_TIME
  FULL_TIME
}

enum ConsultationStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  COMPLETED
}

enum MeetingStatus {
  ONGOING
  COMPLETED
  CANCELLED
}

enum MeetingProvider {
  AGORA
}

enum ConsultationType {
  INSTANT
  SCHEDULED
}